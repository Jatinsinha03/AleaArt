<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AleaArt - Random Number Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section h2 {
            margin-top: 0;
            color: #ffd700;
            font-size: 1.5em;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        input, select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin: 5px;
            width: 200px;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(46, 204, 113, 0.3);
            border: 1px solid #2ecc71;
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
        }
        
        .status.info {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
        }
        
        .random-result {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            word-break: break-all;
        }
        
        .contract-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ AleaArt Random Generator</h1>
        
        <div class="section">
            <h2>üîó Connect Wallet</h2>
            <button id="connectBtn">Connect MetaMask</button>
            <div id="walletStatus" class="status info" style="display: none;">
                Connected: <span id="walletAddress"></span>
            </div>
        </div>
        
        <div class="section">
            <h2>üìã Contract Information</h2>
            <div class="contract-info">
                <strong>Contract Address:</strong> 0xe20CF41Cd65E9F24d9d5E37f6ED6Cc2b099c0c6D<br>
                <strong>Network:</strong> Arbitrum Sepolia<br>
                <strong>Entropy Address:</strong> 0x549Ebba8036Ab746611B4fFA1423eb0A4Df61440
            </div>
        </div>
        
        <div class="section">
            <h2>üéØ Generate Random Number</h2>
            <button id="requestRandomBtn" disabled>Request Random Number</button>
            <button id="checkRandomBtn" disabled>Check Random Results</button>
            
            <div id="randomStatus" class="status info" style="display: none;"></div>
            
            <div id="randomResults" style="display: none;">
                <h3>üé≤ Random Numbers Generated:</h3>
                <div id="randomNumbers"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>üí∞ Get Required Fee</h2>
            <button id="getFeeBtn" disabled>Get Required Fee</button>
            <div id="feeInfo" class="status info" style="display: none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Wait for ethers to load with timeout
        let ethersLoaded = false;
        
        // Check if ethers loaded immediately
        if (typeof ethers !== 'undefined') {
            ethersLoaded = true;
            console.log('Ethers library loaded immediately');
            initializeApp();
        } else {
            // Wait for load event
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (typeof ethers !== 'undefined') {
                        ethersLoaded = true;
                        console.log('Ethers library loaded after timeout');
                        initializeApp();
                    } else {
                        console.error('Ethers library failed to load');
                        document.body.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: white;">
                                <h1>‚ùå Error: Ethers library failed to load</h1>
                                <p>Please try one of these solutions:</p>
                                <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                                    <li>Refresh the page (Ctrl+F5)</li>
                                    <li>Check your internet connection</li>
                                    <li>Try opening in a different browser</li>
                                    <li>Disable ad blockers temporarily</li>
                                </ul>
                                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer;">Refresh Page</button>
                            </div>
                        `;
                    }
                }, 2000); // Wait 2 seconds
            });
        }
        
        function initializeApp() {
            // Contract configuration
            const CONTRACT_ADDRESS = '0xe20CF41Cd65E9F24d9d5E37f6ED6Cc2b099c0c6D';
            const ENTROPY_ADDRESS = '0x549Ebba8036Ab746611B4fFA1423eb0A4Df61440';
            const ARBITRUM_SEPOLIA_CHAIN_ID = '0x66eee'; // 421614 in hex
            
            // Contract ABI (simplified)
            const CONTRACT_ABI = [
                "function requestRandomNumber() external payable",
                "function randomResults(uint64) external view returns (bytes32)",
                "function entropy() external view returns (address)",
                "event Requested(uint64 sequenceNumber)",
                "event Fulfilled(uint64 sequenceNumber, bytes32 randomNumber)"
            ];
            
            const ENTROPY_ABI = [
                "function getFeeV2() external view returns (uint256)"
            ];
            
            let provider, signer, contract, entropyContract;
            let currentSequenceNumber = null;
            
            // Initialize when page loads
            if (typeof window.ethereum !== 'undefined') {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                entropyContract = new ethers.Contract(ENTROPY_ADDRESS, ENTROPY_ABI, provider);
                
                // Check if already connected
                window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                }).catch(console.error);
            } else {
                showStatus('walletStatus', 'error', 'MetaMask not detected. Please install MetaMask to use this app.');
            }
            
            // Connect wallet
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            
            // Get required fee
            document.getElementById('getFeeBtn').addEventListener('click', async () => {
                try {
                    showStatus('feeInfo', 'info', 'Getting fee...');
                    const fee = await entropyContract.getFeeV2();
                    const feeInEth = ethers.utils.formatEther(fee);
                    showStatus('feeInfo', 'success', `Required fee: ${feeInEth} ETH`);
                } catch (error) {
                    showStatus('feeInfo', 'error', `Failed to get fee: ${error.message}`);
                }
            });
            
            // Request random number
            document.getElementById('requestRandomBtn').addEventListener('click', async () => {
                try {
                    showStatus('randomStatus', 'info', 'Requesting random number...');
                    
                    // Get the required fee
                    const fee = await entropyContract.getFeeV2();
                    const feeInEth = ethers.utils.formatEther(fee);
                    
                    // Add some extra for gas
                    const totalValue = fee.add(ethers.utils.parseEther('0.001'));
                    
                    // Request random number
                    const tx = await contract.requestRandomNumber({ value: totalValue });
                    showStatus('randomStatus', 'info', `Transaction sent: ${tx.hash}`);
                    
                    // Wait for transaction
                    const receipt = await tx.wait();
                    
                    // Get sequence number from event
                    const event = receipt.events.find(e => e.event === 'Requested');
                    if (event) {
                        currentSequenceNumber = event.args.sequenceNumber.toString();
                        showStatus('randomStatus', 'success', `Random number requested! Sequence: ${currentSequenceNumber}`);
                    }
                    
                } catch (error) {
                    showStatus('randomStatus', 'error', `Request failed: ${error.message}`);
                }
            });
            
            // Check random results
            document.getElementById('checkRandomBtn').addEventListener('click', async () => {
                try {
                    if (!currentSequenceNumber) {
                        showStatus('randomStatus', 'error', 'No sequence number available. Request a random number first.');
                        return;
                    }
                    
                    showStatus('randomStatus', 'info', 'Checking for random number...');
                    
                    const randomResult = await contract.randomResults(currentSequenceNumber);
                    
                    if (randomResult === '0x0000000000000000000000000000000000000000000000000000000000000000') {
                        showStatus('randomStatus', 'info', 'Random number not yet generated. This may take some time...');
                    } else {
                        showStatus('randomStatus', 'success', 'Random number generated!');
                        
                        // Display the result
                        const resultsDiv = document.getElementById('randomNumbers');
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'random-result';
                        resultDiv.innerHTML = `
                            <strong>Sequence ${currentSequenceNumber}:</strong><br>
                            ${randomResult}
                        `;
                        resultsDiv.appendChild(resultDiv);
                        
                        document.getElementById('randomResults').style.display = 'block';
                    }
                    
                } catch (error) {
                    showStatus('randomStatus', 'error', `Check failed: ${error.message}`);
                }
            });
            
            async function connectWallet() {
            try {
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Get signer
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== 421614) {
                    await switchToArbitrumSepolia();
                }
                
                // Update contract with signer
                contract = contract.connect(signer);
                
                // Show connected status
                document.getElementById('walletAddress').textContent = address;
                showStatus('walletStatus', 'success', `Connected: ${address}`);
                
                // Enable buttons
                document.getElementById('requestRandomBtn').disabled = false;
                document.getElementById('checkRandomBtn').disabled = false;
                document.getElementById('getFeeBtn').disabled = false;
                
            } catch (error) {
                showStatus('walletStatus', 'error', `Connection failed: ${error.message}`);
            }
        }
        
        async function switchToArbitrumSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: ARBITRUM_SEPOLIA_CHAIN_ID }],
                });
            } catch (switchError) {
                // If network doesn't exist, add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: ARBITRUM_SEPOLIA_CHAIN_ID,
                                chainName: 'Arbitrum Sepolia',
                                rpcUrls: ['https://sepolia-rollup.arbitrum.io/rpc'],
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                blockExplorerUrls: ['https://sepolia.arbiscan.io/']
                            }],
                        });
                    } catch (addError) {
                        throw new Error('Failed to add Arbitrum Sepolia network');
                    }
                } else {
                    throw switchError;
                }
            }
        }
        
        // Get required fee
        document.getElementById('getFeeBtn').addEventListener('click', async () => {
            try {
                showStatus('feeInfo', 'info', 'Getting fee...');
                const fee = await entropyContract.getFeeV2();
                const feeInEth = ethers.utils.formatEther(fee);
                showStatus('feeInfo', 'success', `Required fee: ${feeInEth} ETH`);
            } catch (error) {
                showStatus('feeInfo', 'error', `Failed to get fee: ${error.message}`);
            }
        });
        
        // Request random number
        document.getElementById('requestRandomBtn').addEventListener('click', async () => {
            try {
                showStatus('randomStatus', 'info', 'Requesting random number...');
                
                // Get the required fee
                const fee = await entropyContract.getFeeV2();
                const feeInEth = ethers.utils.formatEther(fee);
                
                // Add some extra for gas
                const totalValue = fee.add(ethers.utils.parseEther('0.001'));
                
                // Request random number
                const tx = await contract.requestRandomNumber({ value: totalValue });
                showStatus('randomStatus', 'info', `Transaction sent: ${tx.hash}`);
                
                // Wait for transaction
                const receipt = await tx.wait();
                
                // Get sequence number from event
                const event = receipt.events.find(e => e.event === 'Requested');
                if (event) {
                    currentSequenceNumber = event.args.sequenceNumber.toString();
                    showStatus('randomStatus', 'success', `Random number requested! Sequence: ${currentSequenceNumber}`);
                }
                
            } catch (error) {
                showStatus('randomStatus', 'error', `Request failed: ${error.message}`);
            }
        });
        
        // Check random results
        document.getElementById('checkRandomBtn').addEventListener('click', async () => {
            try {
                if (!currentSequenceNumber) {
                    showStatus('randomStatus', 'error', 'No sequence number available. Request a random number first.');
                    return;
                }
                
                showStatus('randomStatus', 'info', 'Checking for random number...');
                
                const randomResult = await contract.randomResults(currentSequenceNumber);
                
                if (randomResult === '0x0000000000000000000000000000000000000000000000000000000000000000') {
                    showStatus('randomStatus', 'info', 'Random number not yet generated. This may take some time...');
                } else {
                    showStatus('randomStatus', 'success', 'Random number generated!');
                    
                    // Display the result
                    const resultsDiv = document.getElementById('randomNumbers');
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'random-result';
                    resultDiv.innerHTML = `
                        <strong>Sequence ${currentSequenceNumber}:</strong><br>
                        ${randomResult}
                    `;
                    resultsDiv.appendChild(resultDiv);
                    
                    document.getElementById('randomResults').style.display = 'block';
                }
                
            } catch (error) {
                showStatus('randomStatus', 'error', `Check failed: ${error.message}`);
            }
        });
        
            function showStatus(elementId, type, message) {
                const element = document.getElementById(elementId);
                element.className = `status ${type}`;
                element.textContent = message;
                element.style.display = 'block';
            }
        }
    </script>
</body>
</html>
